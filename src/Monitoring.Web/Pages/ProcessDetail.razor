@page "/processes/{Name}"
@inject ProcessService ProcessService
@* Use an alias for the model class to avoid a naming conflict with this page *@
@using ProcessModel = Monitoring.Web.Models.ProcessDetail
@using Monitoring.Web.Models
@using Monitoring.Web.Components

<PageTitle>Process Details</PageTitle>

@if (_detail is null)
{
    <MudText Typo="Typo.h5">Process not found.</MudText>
}
else
{
    <MudStack Spacing="2">
        <MudPaper Class="pa-4">
            <MudStack Spacing="1">
                <MudText Typo="Typo.h5">@_detail.Name</MudText>
                <MudStack Row="true" Spacing="1">
                    <MudChip T="string" Color="Color.Primary" Variant="Variant.Filled">@(_detail.Completed ? "Completed" : "Incomplete")</MudChip>
                    <MudChip T="string" Color="Color.Secondary" Variant="Variant.Filled">Last Run: @_detail.LastRun.ToString("g")</MudChip>
                    <MudChip T="string" Color="Color.Info" Variant="Variant.Filled">Duration: @_detail.DurationMinutes&nbsp;min</MudChip>
                    <MudChip T="string" Color="Color.Info" Variant="Variant.Filled">Expected: @_detail.ExpectedMinMinutes-@_detail.ExpectedMaxMinutes&nbsp;min</MudChip>
                    <MudChip T="string" Color="Color.Tertiary" Variant="Variant.Filled">Status: @_detail.Status</MudChip>
                </MudStack>
                <MudDivider Class="my-2" />
                <MudText Typo="Typo.h6">Run Duration History</MudText>
                <!-- Plotly chart showing run durations history -->
                <ProcessRunChart Durations="_detail.DurationHistory" />
            </MudStack>
        </MudPaper>

        <MudPaper Class="pa-4 mt-4">
            <MudText Typo="Typo.h6">API Health</MudText>
            <MudTable Items="_detail.Apis" Dense="true">
                <HeaderContent>
                    <MudTh>Name</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Resp. Time (ms)</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.Name</MudTd>
                    <MudTd><StatusDot Status="@(context.Healthy ? "Healthy" : "Unhealthy")" /></MudTd>
                    <MudTd>@context.ResponseTimeMs</MudTd>
                </RowTemplate>
            </MudTable>
        </MudPaper>

        <MudPaper Class="pa-4 mt-4">
            <MudText Typo="Typo.h6">Database Connections</MudText>
            <MudTable Items="_detail.Databases" Dense="true">
                <HeaderContent>
                    <MudTh>Name</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Latency (ms)</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.Name</MudTd>
                    <MudTd><StatusDot Status="@(context.Connected ? "Healthy" : "Unhealthy")" /></MudTd>
                    <MudTd>@context.LatencyMs</MudTd>
                </RowTemplate>
            </MudTable>
        </MudPaper>

        <MudPaper Class="pa-4 mt-4 mb-4">
            <MudText Typo="Typo.h6">Service Accounts</MudText>
            <MudTable Items="_detail.ServiceAccounts" Dense="true">
                <HeaderContent>
                    <MudTh>Name</MudTh>
                    <MudTh>Status</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.Name</MudTd>
                    <MudTd><StatusDot Status="@(context.HasAccess ? "Healthy" : "Unhealthy")" /></MudTd>
                </RowTemplate>
            </MudTable>
        </MudPaper>
    </MudStack>
}

@code {
    [Parameter] public string Name { get; set; } = string.Empty;
    // Use the aliased ProcessModel type for the backing field to avoid name
    // conflicts with this page's partial class name.
    private ProcessModel? _detail;

    protected override void OnParametersSet()
    {
        _detail = ProcessService.GetProcess(Uri.UnescapeDataString(Name));
    }
}