@page "/"
@using MudBlazor
@inject ICheckStore CheckStore
@inject IResultStore ResultStore
@inject Monitoring.Web.Services.SqlJobService SqlSvc

<MudStack Spacing="3">

    <!-- Top bar -->
    <MudPaper Class="pa-3 toolbar">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudAvatar Icon="@Icons.Material.Filled.MonitorHeart" Size="Size.Medium" />
            <MudStack>
                <MudText Typo="Typo.h6">IT Operations Monitor</MudText>
                <MudText Typo="Typo.caption" Class="opacity-70">
                    System health &amp; nightly processing
                </MudText>
            </MudStack>

            <MudSpacer />

                    <!-- Environment filter -->
            <MudSelect T="string" Label="Environment" Dense="true" @bind-Value="_selectedEnv" Class="w-40">
                <MudSelectItem T="string" Value="@("__ALL__")">All Environments</MudSelectItem>
                @foreach (var env in _environments)
                {
                    <MudSelectItem T="string" Value="@env">@env</MudSelectItem>
                }
            </MudSelect>

            <!-- Time window -->
            <MudSelect T="string" Label="Window" Dense="true" @bind-Value="_window">
                <MudSelectItem T="string" Value="@("Last24Hours")">Last 24h</MudSelectItem>
                <MudSelectItem T="string" Value="@("Last7Days")">Last 7d</MudSelectItem>
                <MudSelectItem T="string" Value="@("Last30Days")">Last 30d</MudSelectItem>
            </MudSelect>
        </MudStack>
    </MudPaper>

    <!-- KPI cards -->
    <MudGrid>
        @foreach (var kpi in _kpis)
        {
            <MudItem xs="12" sm="6" md="4" lg="2">
                <div class="kpi-card">
                    <div class="kpi-title">@kpi.Title</div>
                    <div class="kpi-value">@kpi.Healthy / @kpi.Total</div>
                    <div class="kpi-sub">@kpi.PercentHealthy% healthy</div>
                </div>
            </MudItem>
        }
    </MudGrid>

    <!-- Nightly Job Trends + Recent Alerts -->
    <MudGrid>
        <MudItem xs="12" md="8">
            <div class="trend-card">
                <MudStack Spacing="1">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudText Typo="Typo.h6">Nightly Job Trends</MudText>
                        <MudSpacer />
                        <MudSelect T="string" Dense="true" @bind-Value="_selectedSqlJobId" Label="Job">
                            @foreach (var job in _sqlJobs)
                            {
                                <MudSelectItem Value="@job.Id">@job.Name</MudSelectItem>
                            }
                        </MudSelect>
                        <MudSelect T="int" Dense="true" @bind-Value="_historyTake" Label="Points">
                            <MudSelectItem Value="7">7</MudSelectItem>
                            <MudSelectItem Value="14">14</MudSelectItem>
                            <MudSelectItem Value="30">30</MudSelectItem>
                        </MudSelect>
                        <MudButton Variant="Variant.Outlined"
                                   StartIcon="@Icons.Material.Filled.Refresh"
                                   OnClick="ReloadChartAsync">
                            Reload
                        </MudButton>
                    </MudStack>

                    @if (_plotData is null)
                    {
                        <MudSkeleton Height="220px" />
                    }
                    else
                    {
                        <PlotlyChart Data="_plotData" Layout="_plotLayout" Config="_plotConfig" HeightPx="220" />
                    }
                </MudStack>
            </div>
        </MudItem>

        <MudItem xs="12" md="4">
            <MudPaper Class="pa-3 recent-alerts" Style="height:320px;overflow:auto;">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.h6">Recent Alerts</MudText>
                    <MudText Typo="Typo.caption" Class="opacity-70">@_activeAlertsCount active</MudText>

                    @if (_recentAlerts.Count == 0)
                    {
                        <MudText Class="opacity-70">No alerts in the selected window.</MudText>
                    }
                    else
                    {
                        <MudList T="AlertItem" Dense="true">
                            @foreach (var a in _recentAlerts)
                            {
                                <MudListItem T="AlertItem">
                                    <MudStack Spacing="1">
                                        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                                            @if (a.Status == CheckStatus.Unhealthy)
                                            {
                                                <MudIcon Icon="@Icons.Material.Filled.Error" Size="Size.Small" />
                                            }
                                            else if (a.Status == CheckStatus.Degraded)
                                            {
                                                <MudIcon Icon="@Icons.Material.Filled.Warning" Size="Size.Small" />
                                            }
                                            else
                                            {
                                                <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" />
                                            }
                                            <MudText Typo="Typo.body2">@a.Name</MudText>
                                            <MudSpacer />
                                            <MudText Typo="Typo.caption">@a.ObservedAtLocal.ToString("g")</MudText>
                                        </MudStack>
                                        @if (!string.IsNullOrWhiteSpace(a.Message))
                                        {
                                            <MudText Typo="Typo.caption" Class="opacity-80">@a.Message</MudText>
                                        }
                                    </MudStack>
                                </MudListItem>
                            }
                        </MudList>
                    }
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <!-- Filter + Grid -->
    <MudPaper Class="pa-3">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="searchbar mb-2">
            <MudTextField @bind-Value="_search"
                          Placeholder="Search services, jobs, or tags..."
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Dense="true" />
        </MudStack>

        <MudTable Items="_filteredRows" Dense="true" Hover="true" Bordered="true" Striped="true">
            <HeaderContent>
                <MudTh>Service</MudTh>
                <MudTh>Type</MudTh>
                <MudTh>Status</MudTh>
                <MudTh>Environment</MudTh>
                <MudTh>Last Check</MudTh>
                <MudTh></MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>@context.Name</MudTd>
                <MudTd>@context.Type</MudTd>
                <MudTd>
                    @if (_latest.TryGetValue(context.Id, out var last))
                    {
                        @if (last.Status == CheckStatus.Healthy)
                        {
                            <MudChip T="string" Color="Color.Success" Size="Size.Small">Ok</MudChip>
                        }
                        else if (last.Status == CheckStatus.Degraded)
                        {
                            <MudChip T="string" Color="Color.Warning" Size="Size.Small">Warning</MudChip>
                        }
                        else if (last.Status == CheckStatus.Unhealthy)
                        {
                            <MudChip T="string" Color="Color.Error" Size="Size.Small">Error</MudChip>
                        }
                        else
                        {
                            <MudChip T="string" Size="Size.Small">Unknown</MudChip>
                        }
                    }
                    else
                    {
                        <MudChip T="string" Size="Size.Small">No data</MudChip>
                    }
                </MudTd>
                <MudTd>@(GetEnv(context) ?? "â€”")</MudTd>
                <MudTd>@(_latest.TryGetValue(context.Id, out var r2)
                    ? r2.ObservedAt.ToLocalTime().ToString("g")
                    : "")</MudTd>
                <MudTd Class="table-actions">
                    <MudLink Href=$"/job/{context.Id}">
                        <MudIcon Icon="@Icons.Material.Filled.OpenInNew" />
                    </MudLink>
                </MudTd>
            </RowTemplate>
        </MudTable>
    </MudPaper>

</MudStack>

@code {
    private List<CheckDescriptor> _rows = new();
    private List<CheckDescriptor> _filteredRows = new();
    private readonly Dictionary<string, CheckResult> _latest = new();
    private readonly HashSet<string> _environments = new();

    private string _selectedEnv = "__ALL__";   // sentinel for "All Environments"
    private string _search = string.Empty;
    private string _window = "Last24Hours";

    // KPIs
    private record Kpi(string Title, int Healthy, int Total)
    {
        public int PercentHealthy => Total == 0 ? 0 : (int)Math.Round((double)Healthy * 100d / Total);
    }
    private List<Kpi> _kpis = new();

    // Alerts
    private class AlertItem
    {
        public string Id { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public CheckStatus Status { get; set; }
        public string? Message { get; set; }
        public DateTimeOffset ObservedAt { get; set; }
        public DateTime ObservedAtLocal => ObservedAt.ToLocalTime().DateTime;
    }
    private List<AlertItem> _recentAlerts = new();
    private int _activeAlertsCount;

    // SQL Job chart (Plotly)
    private List<CheckDescriptor> _sqlJobs = new();
    private string? _selectedSqlJobId;
    private int _historyTake = 14;
    private object? _plotData;
    private object? _plotLayout;
    private object? _plotConfig;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _rows = (await CheckStore.ListAsync()).ToList();
        _latest.Clear();
        _environments.Clear();

        foreach (var d in _rows)
        {
            var latest = await ResultStore.GetLatestAsync(d.Id);
            if (latest is not null)
                _latest[d.Id] = latest;

            var env = GetEnv(d);
            if (!string.IsNullOrWhiteSpace(env))
                _environments.Add(env);
        }

        BuildKpis();
        await BuildAlertsAsync();
        BuildSqlJobs();
        ApplyFilters();
        await ReloadChartAsync();
    }

    private void BuildKpis()
    {
        (int ok, int total) Count(Func<CheckDescriptor, bool> pred)
        {
            var set = _rows.Where(pred).ToList();
            var healthy = set.Count(d =>
                _latest.TryGetValue(d.Id, out var r) &&
                r.Status == CheckStatus.Healthy);
            return (healthy, set.Count);
        }

        var jobs = Count(d => d.Type.Contains("job", StringComparison.OrdinalIgnoreCase));
        var apis = Count(d => d.Type.Contains("http", StringComparison.OrdinalIgnoreCase) ||
                              d.Type.Contains("api", StringComparison.OrdinalIgnoreCase));
        var dbs = Count(d => d.Type.Contains("db", StringComparison.OrdinalIgnoreCase) ||
                             d.Type.Contains("sql", StringComparison.OrdinalIgnoreCase));
        var accounts = Count(d => d.Type.Contains("account", StringComparison.OrdinalIgnoreCase));
        var servers = Count(d => d.Type.Contains("server", StringComparison.OrdinalIgnoreCase) ||
                                 d.Type.Contains("host", StringComparison.OrdinalIgnoreCase));
        var tickets = Count(d => d.Type.Contains("ticket", StringComparison.OrdinalIgnoreCase) ||
                                 d.Name.Contains("ServiceNow", StringComparison.OrdinalIgnoreCase));

        _kpis = new()
        {
            new Kpi("Jobs", jobs.ok, jobs.total),
            new Kpi("APIs", apis.ok, apis.total),
            new Kpi("Databases", dbs.ok, dbs.total),
            new Kpi("Accounts", accounts.ok, accounts.total),
            new Kpi("Servers", servers.ok, servers.total),
            new Kpi("Open Tickets", tickets.ok, tickets.total)
        };
    }

    private async Task BuildAlertsAsync()
    {
        var (from, to) = GetWindowUtc();
        var buffer = new List<AlertItem>();

        foreach (var d in _rows)
        {
            var recent = await ResultStore.ListRecentAsync(d.Id, 100);
            foreach (var r in recent)
            {
                if (r.ObservedAt >= from &&
                    (r.Status == CheckStatus.Degraded || r.Status == CheckStatus.Unhealthy))
                {
                    buffer.Add(new AlertItem
                    {
                        Id = d.Id,
                        Name = d.Name,
                        Status = r.Status,
                        Message = r.Message,
                        ObservedAt = r.ObservedAt
                    });
                }
            }
        }

        _recentAlerts = buffer
            .OrderByDescending(a => a.ObservedAt)
            .Take(30)
            .ToList();

        _activeAlertsCount = _recentAlerts.Count(a => a.Status != CheckStatus.Healthy);
    }

    private void BuildSqlJobs()
    {
        _sqlJobs = _rows
            .Where(r =>
                r.Type.Contains("sqlagent", StringComparison.OrdinalIgnoreCase) ||
                r.Type.Contains("SqlAgent", StringComparison.OrdinalIgnoreCase) ||
                r.Type.Contains("SqlAgentJob", StringComparison.OrdinalIgnoreCase) ||
                r.Type.Contains("job", StringComparison.OrdinalIgnoreCase))
            .OrderBy(r => r.Name)
            .ToList();

        if (_selectedSqlJobId is null && _sqlJobs.Count > 0)
            _selectedSqlJobId = _sqlJobs.First().Id;
    }

    private (DateTimeOffset from, DateTimeOffset to) GetWindowUtc()
    {
        var to = DateTimeOffset.UtcNow;
        return _window switch
        {
            "Last7Days" => (to.AddDays(-7), to),
            "Last30Days" => (to.AddDays(-30), to),
            _ => (to.AddDays(-1), to) // Last24Hours
        };
    }

    private void ApplyFilters()
    {
        IEnumerable<CheckDescriptor> q = _rows;

        if (_selectedEnv != "__ALL__" && !string.IsNullOrWhiteSpace(_selectedEnv))
        {
            q = q.Where(d => string.Equals(GetEnv(d), _selectedEnv, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(_search))
        {
            var s = _search.Trim();
            q = q.Where(d =>
                (d.Name?.Contains(s, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (d.Type?.Contains(s, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (string.Join(',', d.Tags ?? Array.Empty<string>())
                    .Contains(s, StringComparison.OrdinalIgnoreCase)));
        }

        _filteredRows = q.OrderBy(d => d.Name).ToList();
    }

    private string? GetEnv(CheckDescriptor d)
    {
        var tag = d.Tags?.FirstOrDefault(t =>
            t.StartsWith("env:", StringComparison.OrdinalIgnoreCase));
        return tag is null ? null : tag.Split(':', 2)[1];
    }

    private async Task ReloadChartAsync()
    {
        _plotData = null;
        _plotLayout = null;
        _plotConfig = null;

        if (string.IsNullOrWhiteSpace(_selectedSqlJobId))
            return;

        var desc = await CheckStore.GetAsync(_selectedSqlJobId);
        if (desc is null)
            return;

        if (!desc.Parameters.TryGetValue("connectionString", out var cs))
            return;
        if (!desc.Parameters.TryGetValue("jobName", out var job))
            return;

        var (exists, _, _, history) =
            await SqlSvc.GetJobSummaryAndHistoryAsync(cs, job, _historyTake);

        if (!exists)
            return;

        var labels = history
            .Select(h => h.at.ToLocalTime().ToString("M/d"))
            .ToArray();

        var minutes = history
            .Select(h => Math.Round(h.durationSec / 60.0, 2))
            .ToArray();

        _plotData = new object[]
        {
            new
            {
                type = "scatter",
                mode = "lines+markers",
                x = labels,
                y = minutes,
                name = job
            }
        };
        _plotLayout = new
        {
            margin = new { l = 40, r = 10, t = 10, b = 30 },
            yaxis = new { title = "Minutes" },
            xaxis = new { title = "" },
            showlegend = false
        };
        _plotConfig = new { responsive = true };
    }

    protected override Task OnParametersSetAsync()
    {
        // Re-apply filters when parameters change (search/env/window)
        ApplyFilters();
        return Task.CompletedTask;
    }
}
